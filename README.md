# å®‰è£…ä½“éªŒ

![1659104674017.jpg](https://upload-images.jianshu.io/upload_images/26002059-1539f775a7a59eb7.png)


![ezgif-1-4516d51ebf.gif](https://upload-images.jianshu.io/upload_images/26002059-891cd1211e3feeb9.gif?imageMogr2/auto-orient/strip)

äº‹å…ˆè¯´æ˜ï¼šæˆ‘åœ¨demoä¸­ä¸€è¿›å…¥Activityå°±ç«‹åˆ»è§¦å‘ä¸‹æ‹‰åˆ·æ–°ï¼Œæ‰€ä»¥ä½ çœ‹åˆ°å¸§ç‡å¯èƒ½æ‰åˆ°äº†40ï¼Œæ˜¯å› ä¸ºç³»ç»Ÿçš„startActivityæœ¬èº«å°±æ‰å¸§éå¸¸å‰å®³ã€‚æƒ³çœŸå®æµ‹å‡ºå¸§ç‡ï¼Œéœ€è¦è¿›å…¥Activityåç­‰å¸§ç‡ç¨³å®šåœ¨60äº†ï¼Œå†æ‰‹åŠ¨ä¸‹æ‹‰åˆ·æ–°

## åŒ…å«åŠŸèƒ½ï¼š
- 9å¼ å›¾ã€‚å¦‚æœåªæœ‰ä¸€å¼ å›¾ï¼Œé‚£ä¹ˆå•å¼ å›¾çš„å®½é«˜æ ¹æ®å›¾ç‰‡åŸå§‹å®½é«˜ç­‰æ¯”ä¾‹ç¼©æ”¾
- åªæœ‰ä¸€å¼ å›¾çš„æ—¶å€™ï¼Œè¿™ä¸ªå›¾å¯èƒ½æ˜¯è§†é¢‘ï¼Œå›¾ä¸­é—´æœ‰æ’­æ”¾æŒ‰é’®
- å†…å®¹æ”¯æŒè¡¨æƒ…ã€‚[å¾®ç¬‘]è¦æ˜¾ç¤ºä¸ºå›¾ç‰‡ğŸ˜Š
- å†…å®¹æœ‰@äººåŠŸèƒ½ï¼Œ@äººæœ‰ç‚¹å‡»äº‹ä»¶
- æ¯ä¸ªItemå¸¦æœ‰è¯„è®ºï¼ŒXXXå›å¤XXXï¼šä½ å¥½[å¾®ç¬‘]

## ä¼ ç»Ÿåšæ³•çš„æ•ˆæœï¼š
- é¦–æ¬¡è¿›å…¥Activityåè§¦å‘ä¸‹æ‹‰åˆ·æ–°ï¼Œè¯·æ±‚æˆåŠŸåsetAdpaterï¼Œè¿™æ—¶å€™å¸§ç‡ä¼šæ‰åˆ°`49å¸§`å·¦å³ã€‚ä¸¢å¤±11å¸§
- æ‰‹æŒ‡å¾€ä¸‹æ»šåŠ¨ï¼Œæ»šåŠ¨è¿‡ç¨‹ä¸­ï¼Œå¸§ç‡åœ¨`57å¸§ - 60å¸§`å¾˜å¾Š
- é€€å‡ºActivityå†æ¬¡è¿›å…¥ï¼Œç”±äºjavaåº•å±‚çš„ä»£ç ä¼˜åŒ–ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šä¸Šå‡ã€‚é¦–æ¬¡setAdpaterå¸§ç‡ä¸º`53å¸§`å·¦å³
<br/>
![165910467401.jpg](https://upload-images.jianshu.io/upload_images/26002059-60631e2c5368e1e9.png)

## æˆ‘ä¼˜åŒ–åçš„æ•ˆæœï¼š
- é¦–æ¬¡è¿›å…¥Activityåè§¦å‘ä¸‹æ‹‰åˆ·æ–°ï¼Œè¯·æ±‚æˆåŠŸåsetAdpaterï¼Œè¿™æ—¶å€™å¸§ç‡ä¼šæ‰åˆ°`57å¸§`å·¦å³ã€‚ä¸¢å¤±3å¸§å·¦å³
- æ‰‹æŒ‡å¾€ä¸‹æ»šåŠ¨ï¼Œæ»šåŠ¨è¿‡ç¨‹ä¸­ï¼Œå…¨ç¨‹60å¸§
<br/>
![165910474648.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df6c5668068d4ef6a29ebc90e18f4c58~tplv-k3u1fbpfcp-watermark.image)


## æˆ‘çš„åŸºç¡€ä¼˜åŒ–æ–¹æ¡ˆï¼ˆåˆ«äººå¸–å­ä¹Ÿä¼šè®²çš„ï¼‰ï¼š
- âœ… 1ã€æ¯ä¸ªitemä¸­ä¼—å¤šå…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ä¸è¦æ¯æ¬¡éƒ½newã€‚åº”è¯¥æ˜¯`onCreateViewHolder`ä¸­imageView.setOnClickListener(this)ã€‚ç„¶ååœ¨`onBindViewHolder`ä¸­imageView.setTagã€‚é¿å…æ»šåŠ¨è¿‡ç¨‹ä¸­é¢‘ç¹new ClickListener()
- âœ… 2ã€SpanTextåšå¥½ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡æ»šåŠ¨éƒ½è§£æã€‚æ€»ä¹‹ï¼Œæ£€æŸ¥Adpaterä¸­æ‰€æœ‰new Object()çš„ä»£ç ï¼Œèƒ½ä¸newå°±ä¸new
- âœ… 3ã€æ‰‹å†™`DrawableCenterTextView`ï¼Œè§£å†³ç³»ç»Ÿçš„Buttonçš„DrawableLeftä¼šè´´è¾¹é—®é¢˜ã€‚å¦åˆ™è¦å¤šä¸€å±‚LinearLayoutåŒ…è£¹
- âœ… 4ã€éœ€è¦é‡å¤è®¡ç®—çš„sizeè¦è®¾ç½®ä¸ºå…¨å±€å˜é‡staticï¼Œé¿å…æ¯æ¬¡è®¡ç®—ã€‚æ¯”å¦‚æ¯å¼ å›¾ç‰‡çš„å®½é«˜ï¼Œè¡¨æƒ…å›¾ç‰‡çš„15spå¤§å°
- âœ… 5ã€åº•éƒ¨åŠ è½½æ›´å¤šï¼šä½¿ç”¨notifyItemRangeInsertedä»£æ›¿notifyDataSetChangedã€‚åè€…ä¼šè§¦å‘2ã€3æ¬¡onCreateViewHolder

## æˆ‘çš„è¿›é˜¶ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä½ åœ¨åˆ«çš„å¸–å­çœ‹ä¸åˆ°çš„ï¼‰ï¼š
- âœ… 1ã€glideé¦–æ¬¡åŠ è½½å›¾ç‰‡ä¼šåˆ›å»ºçº¿ç¨‹æ± ï¼Œè€—æ—¶çº¦50msï¼Œå¯ä»¥ç§»åˆ°Appæ‰“å¼€æ—¶çš„æ¬¢è¿ç•Œé¢å°±åˆ›å»ºå¥½ã€‚èŠ‚çœ50ms
- âœ… 2ã€é¦–æ¬¡setAdpaterå‰å…ˆä¸ç€æ€¥ç»“æŸä¸‹æ‹‰åˆ·æ–°çŠ¶æ€ã€‚å…ˆå¼€å¯Threadï¼Œåœ¨Threadä¸­è§£ææ–‡å­—çš„è¡¨æƒ…å’Œ@äººè§£æï¼Œç»„æˆSpanTextå¹¶ç¼“å­˜åˆ°modelä¸­ï¼ŒèŠ‚çœçº¦12ms
- âœ… 3ã€é‡‡ç”¨`LruCache`ç¼“å­˜æœ€æ–°çš„32ä¸ªè¡¨æƒ…çš„drawableï¼Œè¿™æ ·å¯ä»¥åŠ å¿«å¸¸è§è¡¨æƒ…çš„è§£æé€Ÿåº¦
- âœ… 4ã€åœ¨Threadä¸­æŒ‰List<Model>.count() è§£æitemçš„xmlå¸ƒå±€ï¼Œå¹¶å­˜æ”¾åœ¨LinkedList<View> ä¸­ï¼ˆä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæˆ‘æœ€å¤šé™åˆ¶8æ¡ï¼‰ã€‚åœ¨onCreateViewHolderä¸­è¿›è¡Œ .pollï¼ŒèŠ‚çœ150mså·¦å³
- âœ… 5ã€åœ¨Threadä¸­æŒ‰List<Model>.count() é¢„åˆ›å»ºå›¾ç‰‡å’Œè¯„è®ºçš„`ç¼“å­˜æ± `ï¼šLinkedList<ImageView> å’Œ LinkedList<è¯„è®ºTextView>ã€‚åœ¨itemæ˜¾ç¤ºçš„æ—¶å€™ã€‚ä»ç¼“å†²æ± ä¸­å–ï¼Œè€Œä¸æ˜¯newã€‚èŠ‚çœ100mså·¦å³
- âœ… 6ã€åœ¨Adpaterçš„ `onViewRecycled` ä¸­æŠŠå›¾ç‰‡å’Œè¯„è®ºremoveåå­˜å…¥ç¼“å­˜æ± ã€‚è¿™ä¸€æ­¥ä¸»è¦ä¸ºäº†æ»šåŠ¨æµç•…
- âœ… 7ã€ä¹å¼ å›¾é‡‡ç”¨`GridLayout`è€Œä¸æ˜¯ UnScrollViewæˆ–è€…GridManagerã€‚åè€…ä¼šå¤ªé‡é‡çº§ä¸”ä¼šå¸¦æ¥æ›´å¤šçš„å†…å­˜æ¶ˆè€—ã€‚è¿™é‡Œå…¶å®æœ€å¥½è‡ªå·±å†™ä¸€ä¸ªViewGroup

## æœ¬æ–¹æ¡ˆç”¨åˆ°çš„åŸºç¡€å¸¸è¯†ï¼š
- 1ã€ListViewæˆ–RecyclerViewå¦‚æœå½“å‰æ˜¯ä¸å¯è§çŠ¶æ€ï¼Œä½ å»setAdpaterä¸ä¼šèµ·åˆ°ä»»ä½•æ•ˆæœï¼Œä»£ç ä¸ä¼šèµ°onCreateViewHolderç­‰å›è°ƒã€‚å½“ä½ è®¾ç½®ä¸ºVISIBLEçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘Adapteré‡Œçš„å›è°ƒã€‚
- 2ã€RecyclerViewçš„ç¬¬3çº§ç¼“å­˜`ViewCacheExtension`ï¼Œç”¨èµ·æ¥è¿˜è¦å»åå°„ViewHolderçš„Layout.Paramsï¼ŒæŒºä¸æ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘æ²¡ç”¨ä»–ã€‚
- 3ã€`RecyclerViewPool` ç¼“å­˜æ± æ¯ç§typeçš„æœ€å¤§å€¼é»˜è®¤ä¸º5ã€‚å¦‚æœitemæ˜¯å›ºå®šé«˜åº¦ï¼Œé‚£ä¹ˆç¼“å­˜æ± çš„sizeæ€»æ˜¯åœ¨0å’Œ1ä¹‹é—´å¾˜å¾Šï¼Œå› ä¸ºç¬¬ä¸€ä¸ªitemåˆšè¢«å›æ”¶ï¼Œåº•éƒ¨itemå°±è¿›æ¥äº†ã€‚
- 4ã€æ‰€ä»¥`RecyclerViewPool` ç¼“å­˜æ± åªæœ‰åœ¨éå¸¸æé™æƒ…å†µä¸‹æ‰ä¼šsize == 5 ï¼ˆå³ï¼šé¡¶éƒ¨çš„å‡ ä¸ªitemçš„heightéå¸¸å°ï¼Œä½†æ˜¯åº•éƒ¨çš„itemé«˜åº¦éå¸¸å¤§ï¼‰ã€‚
- 5ã€`onViewRecycled(holder: RecyclerView.ViewHolder)` æ˜¯Itemè¿›å…¥RecyclerViewPoolçš„å›è°ƒï¼Œè¿›å…¥ä¹‹åï¼Œvhçš„dataå°±ç­‰äºæ— ç”¨äº†
- 6ã€`LinkedList` è¦æ¯”`ArrayList`åœ¨å¢åˆ çš„æ—¶å€™æ›´å¿«ï¼Œå°¤å…¶æ˜¯å¢åˆ ç¬¬0ä¸ªå’Œæœ€åä¸€ä¸ªobjectã€‚ä¸”ç”±äºArrayListåº•å±‚ç”¨çš„æ˜¯int[10]ï¼Œ æ‰€ä»¥å­˜åœ¨å†…å­˜æµªè´¹ã€‚æ‰€ä»¥ç”¨LinkedListåšç¼“å­˜æ± ä¼˜äºArrayList

## æœ¬æ–¹æ¡ˆéƒ¨åˆ†æŠ€æœ¯ç»†èŠ‚ï¼š
```
Activityï¼š

      //åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œé¢„åŠ è½½
                    preloadCacheViewsInThread(beanList) {
                        //é¢„åŠ è½½å®Œæ¯•ï¼Œå›åˆ°ä¸»çº¿ç¨‹å¤„ç†UI
                        runOnUiThread {
                            handleRefreshSuccess(beanList)
                        }
                    }

private fun preloadCacheViewsInThread(topicBeanList: MutableList<TopicBean>, success: () -> Unit) {
        Thread {
            var pictureCountInFirstPage = 0 //ç¬¬ä¸€é¡µæœ‰å¤šå°‘ä¸ªå›¾ç‰‡
            var commentCountInFirstPage = 0 //ç¬¬ä¸€é¡µæœ‰å¤šå°‘æ¡å°è¯„è®º
            var nowTime = System.currentTimeMillis()
            for (topicBean in topicBeanList){
                topicBean.findTotalSpanText(this@FriendActivity2, this@FriendActivity2)
                topicBean.pictures?.let { pictureCountInFirstPage += it.count() }
            }
            Log.e(
                "dq",
                "é¢„å¤„ç†Modelè€—æ—¶ä¸ºï¼š" + (System.currentTimeMillis() - nowTime) + "æ¯«ç§’"
            ) //æ–¹æ³•è¿è¡Œæ—¶é—´ä¸ºï¼š12æ¯«ç§’

            val layoutInflater = LayoutInflater.from(this@FriendActivity2)

            //å¼€å§‹é¢„åŠ è½½æ¯ä¸ªItemçš„xmlå¸ƒå±€
            nowTime = System.currentTimeMillis()
            var i = 0
            while (i < 8 && i < topicBeanList.count()) {
                //è¿™ä¸ª8æ˜¯é¢„ä¼°çš„æ•°å­—ï¼Œä¹Ÿå°±æ˜¯å±å¹•ä¸­çš„ + mCacheViewï¼ˆsize == 2ï¼‰+ poolé‡Œçš„ï¼ˆmaxæ˜¯5ï¼Œä¸€èˆ¬å°±æ˜¯1ï¼‰
                val itemView: View = layoutInflater.inflate(R.layout.listitem_topic, null)
               //ç¼“å­˜èµ·æ¥ï¼Œæ”¾åˆ°onCreateHolderä¸­ä½¿ç”¨
                cachedItemViewList!!.add(itemView)
                i++
            }
            Log.e(
                "dq",
                "é¢„åŠ è½½è€—æ—¶ä¸ºï¼š" + (System.currentTimeMillis() - nowTime) + "æ¯«ç§’"
            ) //æ–¹æ³•è¿è¡Œæ—¶é—´ä¸ºï¼š150æ¯«ç§’


            //å¼€å§‹é¢„åŠ è½½æ¯ä¸ªItemä¸­çš„å›¾ç‰‡çš„imageview
            i = 0
            while (i < 10 && i < pictureCountInFirstPage) {
                val pictureImageView = ImageView(this@FriendActivity2)
                cachedImageViewList.add(pictureImageView)
                i++
            }
            Log.e(
                "dq",
                "é¢„Imageå’ŒTextè€—æ—¶ä¸ºï¼š" + (System.currentTimeMillis() - nowTime) + "æ¯«ç§’"
            ) //æ–¹æ³•è¿è¡Œæ—¶é—´ä¸ºï¼š120æ¯«ç§’

            success()

        }.start()
    }

```

```
Adpater:

//åˆ›å»ºViewHolderå¹¶ç»‘å®šä¸Šitemview
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): RecyclerView.ViewHolder {
            var view: View? = null
            cachedItemViewList?.let {
                view = it.poll()
                Log.e("dq", "onCreateViewHolder = ç”¨ä¸Šç¼“å­˜")
            }
            if (view == null){
                view = mInflater.inflate(R.layout.listitem_topic, parent, false)
                Log.e("dq", "onCreateViewHolder = æ²¡ç”¨ä¸Šç¼“å­˜")
            }
            val viewHolder = TopicViewHolder(view!!)

            if (this::cachedImageViewList.isInitialized) {
                //æ˜¯ç”¨äº†é¢„åŠ è½½
                viewHolder.pictureGridLayout.cachedImageViewList = cachedImageViewList
                viewHolder.linearLayoutForListView.cachedTextViewList = cachedTextViewList
            }

            return viewHolder
    }


    override fun onViewRecycled(holder: RecyclerView.ViewHolder) {
        if (holder is TopicViewHolder) {
            for (view in holder.pictureGridLayout.children) {
                if (view is ImageView){
                    //å¿…é¡»è¦ç§»é™¤ï¼Œä¸ç„¶ä¼šï¼šYou must call removeView()
                    cachedImageViewList.add(view);
                    view.setImageDrawable(null)
                    Log.e("dq","ç¼“å†²æ± å›æ”¶å›¾ç‰‡ " + cachedImageViewList.size);
                }
            }
            holder.pictureGridLayout.removeAllViews()

            for (view in holder.linearLayoutForListView.children) {
                if (view is QMUILinkTextView){
                    //å¿…é¡»è¦ç§»é™¤ï¼Œä¸ç„¶ä¼šï¼šThe specified child already has a parent. You must call removeView()
                    cachedTextViewList.add(view);
                    Log.e("dq","ç¼“å†²æ± å›æ”¶è¯„è®º " + cachedTextViewList.size);
                }
            }
            //å¿…é¡»è¦ç§»é™¤ï¼Œä¸ç„¶ä¼šï¼š You must call removeView()
            holder.linearLayoutForListView.removeAllViews()
        }
    }

```


## Authorï¼šDQ  285275534@qq.com

æˆ‘çš„å…¶ä»–å¼€æºåº“ï¼Œç»™ä¸ªStaré¼“åŠ±æˆ‘å†™æ›´å¤šå¥½åº“ï¼š

[Android æœ‹å‹åœˆåˆ—è¡¨Feedæµçš„æœ€ä¼˜åŒ–æ–¹æ¡ˆï¼Œè®©ä½ çš„RecyclerViewä»49å¸§ -> 57å¸§](https://github.com/QDong415/QFeed)

[Android ä»¿å¤§ä¼—ç‚¹è¯„ã€ä»¿å°çº¢ä¹¦ ä¸‹æ‹‰æ‹–æ‹½å…³é—­Activity](https://github.com/QDong415/QDragClose)

[Android ä»¿å¿«æ‰‹ç›´æ’­é—´æ‰‹ç”»ç¤¼ç‰©ï¼Œæ‰‹ç»˜ç¤¼ç‰©](https://github.com/QDong415/QDrawGift)

[Android ç›´æ’­é—´èŠå¤©æ¶ˆæ¯åˆ—è¡¨RecyclerViewã€‚ä¸€ç§’å†…æ”¶åˆ°å‡ ç™¾æ¡æ¶ˆæ¯ä¾ç„¶ä¸å¡é¡¿](https://github.com/QDong415/QLiveMessageHelper)

[Android ä»¿å¿«æ‰‹ç›´æ’­ç•Œé¢åŠ è½½ä¸­ï¼Œé¡¶éƒ¨çš„æ»šåŠ¨æ¡çŠ¶LoadingView](https://github.com/QDong415/QStripeView)

[Android Kotlin MVVMæ¡†æ¶ï¼Œå…¨ä¸–ç•Œæœ€ä¼˜åŒ–çš„åˆ†é¡µåŠ è½½æ¥å£ã€æœ€æ¥åœ°æ°”çš„å°è£…](https://github.com/QDong415/QKotlin)

[Android åŸºäºä¸ªæ¨+åä¸ºpushçš„ä¸€æ•´å¥—å®Œå–„çš„android IMèŠå¤©ç³»ç»Ÿ](https://github.com/QDong415/iTopicChat)

[IOS1:1å®Œç¾ä»¿å¾®ä¿¡èŠå¤©è¡¨æƒ…é”®ç›˜](https://github.com/QDong415/QKeyboardEmotionView)
